name: Deploy Swagger Documentation

on:
    push:
        branches: [main, master]
    workflow_dispatch:

jobs:
    deploy-swagger:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: gerfinweb
                    MYSQL_USER: gerfinweb
                    MYSQL_PASSWORD: gerfinweb
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=3

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build application
              run: yarn build

            - name: Start application and generate Swagger
              env:
                  NODE_ENV: production
                  DB_HOST: 127.0.0.1
                  DB_PORT: 3306
                  DB_USERNAME: gerfinweb
                  DB_PASSWORD: gerfinweb
                  DB_NAME: gerfinweb
                  JWT_SECRET: github-actions-secret
              run: |
                  # Start the application in background
                  npm run start:prod &
                  APP_PID=$!

                  # Wait for application to start
                  sleep 30

                  # Create docs directory
                  mkdir -p docs

                  # Generate swagger.json
                  curl -f http://localhost:8080/api-json > docs/swagger.json

                  # Create HTML file
                  cat > docs/index.html << 'EOF'
                  <!DOCTYPE html>
                  <html>
                  <head>
                    <title>GerfinWeb API Documentation</title>
                    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.10.3/swagger-ui.css" />
                  </head>
                  <body>
                    <div id="swagger-ui"></div>
                    <script src="https://unpkg.com/swagger-ui-dist@5.10.3/swagger-ui-bundle.js"></script>
                    <script src="https://unpkg.com/swagger-ui-dist@5.10.3/swagger-ui-standalone-preset.js"></script>
                    <script>
                      window.onload = function() {
                        SwaggerUIBundle({
                          url: './swagger.json',
                          dom_id: '#swagger-ui',
                          presets: [
                            SwaggerUIBundle.presets.apis,
                            SwaggerUIStandalonePreset
                          ],
                          layout: "StandaloneLayout"
                        });
                      };
                    </script>
                  </body>
                  </html>
                  EOF

                  # Stop the application
                  kill $APP_PID

            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./docs
